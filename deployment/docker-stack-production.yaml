version: '3.7'

services:
  proxy:
    image: traefik
    command: --api \
      --docker \
      --docker.swarmmode \
      --docker.watch \
      --logLevel=DEBUG
    ports:
      - '80:80'
      - '443:443'
      - '8080:8080'
    volumes:
      - '/var/run/docker.sock:/var/run/docker.sock'
      - './traefik.toml:/traefik.toml'
      - 'proxy-data:/data'

  app:
    image: registry.gitlab.com/blasttheory/gift/gift-app:latest-production
    volumes:
      - './nginx-app.conf:/etc/nginx/nginx.conf'
    deploy:
      replicas: 2
      labels:
        - 'traefik.enable=true'
        - 'traefik.port=80'
        - 'traefik.domain=thegift.app'
        - 'traefik.frontend.rule=Host:thegift.app,www.thegift.app'
        - 'traefik.frontend.redirect.regex=^https://www.thegift.app/(.*)$$'
        - 'traefik.frontend.redirect.replacement=https://thegift.app/$$1'

  app-demo:
    image: registry.gitlab.com/blasttheory/gift/gift-app:latest-production
    volumes:
      - './nginx-app.conf:/etc/nginx/nginx.conf'
    deploy:
      replicas: 2
      labels:
        - 'traefik.enable=true'
        - 'traefik.port=80'
        - 'traefik.domain=demo.thegift.app'
        - 'traefik.frontend.rule=Host:demo.thegift.app'

  app-munch:
    image: registry.gitlab.com/blasttheory/gift/gift-app:latest-production
    volumes:
      - './nginx-app.conf:/etc/nginx/nginx.conf'
    deploy:
      replicas: 2
      labels:
        - 'traefik.enable=true'
        - 'traefik.port=80'
        - 'traefik.domain=munchgift.com'
        - 'traefik.frontend.rule=Host:munchgift.com'

  api:
    image: registry.gitlab.com/blasttheory/gift/gift-api:latest
    environment:
      ENVIRONMENT: 'production'
      DEBUG: '(INFO|WARN|ERROR):*'
      SQL_URI: 'postgresql://gift:gift@db/gift'
      CORS_ALLOWED_ORIGINS: 'https://thegift.app, https://demo.thegift.app, https://munchgift.com'
      AWS_BUCKET: 'bt-gift'
      AWS_REGION: 'eu-west-2'
    deploy:
      replicas: 2
      labels:
        - 'traefik.enable=true'
        - 'traefik.port=5000'
        - 'traefik.domain=api.thegift.app'
        - 'traefik.frontend.rule=Host:api.thegift.app'

volumes:
   proxy-data:
